var ChatRoom=angular.module("ChatRoom",["ngRoute"]);ChatRoom.config(["$routeProvider",function(a){a.when("/login",{templateUrl:"views/login.html",controller:"LoginController"}).when("/rooms/:user",{templateUrl:"views/rooms.html",controller:"RoomsController"}).when("/rooms/:user/:room",{templateUrl:"views/room.html",controller:"RoomController"}).otherwise({redirectTo:"/login"})}]),ChatRoom.controller("LoginController",function(a,b,c,d,e){a.errorMessage="",a.nickname="",a.login=function(){""===a.nickname?a.errorMessage="Please choose a nickname before continuing!":e.emit("adduser",a.nickname,function(c){c?b.path("/rooms/"+a.nickname):a.errorMessage="This nickname is already taken!"})}}),ChatRoom.controller("RoomController",function(a,b,c,d,e){a.currentRoom=d.room,a.currentUser=d.user,a.users=[],a.ops=[],a.messageHistory=[],a.topic="",a.banned=!1,a.nextMessage="",a.errorMessage="",a.isOp=!1,a.userToKick="",a.privateMessage="",a.fromUser="";var f={room:a.currentRoom};e.emit("joinroom",f,function(b){b||(a.errorMessage="You have been banned from this room, you cannot see any activity or send messages",a.banned=!0)}),a.partRoom=function(){b.path("/rooms/"+a.currentUser),e.emit("partroom",a.currentRoom)},a.sendMsg=function(){if(""!==a.nextMessage){var b={roomName:a.currentRoom,msg:a.nextMessage};e.emit("sendmsg",b),$("#msg").val(""),a.nextMessage=""}},a.privateMsg=function(b){if(""!==a.nextMessage){var c={nick:b,message:a.nextMessage};console.log("nick: "+c.user),console.log("message: "+c.message),e.emit("privatemsg",c,function(b){b||(a.errorMessage="Could not send message")})}},a.kickUser=function(b){var c={user:b,room:a.currentRoom};e.emit("kick",c,function(b){b||(a.errorMessage="Could not kick user")})},a.banUser=function(b){var c={user:b,room:a.currentRoom};e.emit("ban",c,function(c){c||(a.errorMessage="Could not ban "+b)})},e.on("recv_privatemsg",function(b,c){a.fromUser=b,a.privateMessage=c}),e.on("banned",function(c,d){a.currentRoom===c&&a.currentUser===d&&b.path("/rooms/"+a.currentUser)}),e.on("kicked",function(c,d){a.currentRoom===c&&a.currentUser===d&&b.path("/rooms/"+a.currentUser)}),e.on("updateusers",function(b,c,d){if(b===a.currentRoom&&!a.banned){a.users=[],a.ops=[];for(var f in d)a.ops.push(f);for(var g in c)a.users.push(g);if(0===a.ops.length&&a.users.length>0){var h=a.users.shift(),i={user:h,room:a.currentRoom};e.emit("op",i,function(a){a&&console.log("user : "+i.user+" in room "+i.room+" opped!")})}for(var j=0;j<a.ops.length;j++)a.currentUser===a.ops[j]&&(a.isOp=!0)}}),e.on("updatechat",function(b,c){b!==a.currentRoom||a.banned||(a.messageHistory=c)}),e.on("updatetopic",function(b,c){b!==a.currentRoom||a.banned||(a.topic=c)})}),ChatRoom.controller("RoomsController",function(a,b,c,d,e){a.rooms=[],a.roomList=[],a.currentUser=d.user,a.errorMessage="",a.successMessage="",a.roomName="",e.emit("rooms"),e.on("roomlist",function(b){a.roomList=[];for(var c in b)a.roomList.push(c)}),a.enterRoom=function(c){b.path("/rooms/"+a.currentUser+"/"+c)},a.createRoom=function(){for(var c={room:a.roomName},d=!1,e=0;e<a.roomList.length;e++)c.room===a.roomList[e]&&(d=!0);d?a.errorMessage="Room name already exists":""!==a.roomName?(b.path("/rooms/"+a.currentUser+"/"+c.room),console.log("redirect to ze room")):a.errorMessage="Room name cannot be empty"}}),ChatRoom.factory("socket",function(a){var b=io.connect("http://localhost:8080");return{on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})}}});